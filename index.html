<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <title>Answer Sheet Register - Backup System</title>
    <style>
        body { font-family: 'SolaimanLipi', Arial, sans-serif; background-color: #f0f2f5; padding: 20px; }
        .no-print { background: #fff; padding: 20px; border-radius: 8px; max-width: 950px; margin: 0 auto 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: center; }
        .container { width: 100%; max-width: 1000px; margin: 0 auto; background: white; padding: 40px; border: 1px solid #ddd; }
        
        .institute-header { text-align: center; margin-bottom: 5px; }
        .institute-header h3 { margin: 0; font-size: 20px; }
        .institute-header p { margin: 5px 0; font-size: 16px; }
        
        .header { text-align: center; margin-bottom: 25px; border-top: 1px double #000; padding-top: 15px; }
        .header h4 { margin: 0; font-size: 16px; text-decoration: underline; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid black; padding: 8px; text-align: center; font-size: 16px; }
        th { background-color: #f2f2f2; }
        .total-row { background-color: #eee; font-weight: bold; }
        
        input, select { width: 95%; border: none; text-align: center; font-size: 16px; font-family: inherit; background: transparent; }
        input:focus { outline: none; background: #fffde7; }
        
        .footer { margin-top: 60px; display: flex; justify-content: space-between; }
        .sig-box { border-top: 1px solid black; width: 200px; text-align: center; padding-top: 5px; font-weight: bold; }

        @media print {
            @page {
                size: auto;
                margin: 2mm 10mm 5mm 10mm;
            }
            .no-print { display: none; }
            body { background: white; padding: 0 !important; margin: 0 !important; }
            .container { 
                border: none; 
                width: 100%; 
                max-width: 100%;
                padding: 10px 0 0 0 !important;
                margin: 0 !important; 
            }
            select { -webkit-appearance: none; -moz-appearance: none; appearance: none; border: none; background: none; color: black; }
            input[type=number]::-webkit-inner-spin-button, 
            input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        }
        
        .btn { padding: 10px 15px; border: none; cursor: pointer; border-radius: 4px; color: white; margin: 5px; font-weight: bold; }
    </style>
</head>
<body>
<div id="login-screen" style="position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center;">
  <h3>অনুগ্রহ করে পাসওয়ার্ড দিন</h3>
  <input type="password" id="pass-input" style="padding:10px; margin-bottom:10px; border-radius:5px; border:1px solid #ccc;">
  <button onclick="checkPass()" style="padding:10px 20px; cursor:pointer; background:#28a745; color:white; border:none; border-radius:5px;">Login</button>
  <p id="error-msg" style="color:red; display:none;">ভুল পাসওয়ার্ড!</p>
</div>

<div class="no-print">
    <h3>অটো-সেভ কন্ট্রোল প্যানেল</h3>
    <textarea id="teacherList" style="width: 80%; height: 50px; margin-bottom: 10px;" oninput="saveAllData()">খাজা নূর খোকন, মো: আব্দুর রহিম, মোসা: আমেনা খাতুন</textarea><br>
    
    <button class="btn" style="background: #007bff;" onclick="addRow()">+ নতুন সারি</button>
    <button class="btn" style="background: #ff9800;" onclick="mergeCells()">স্মার্ট মার্জ</button>
    
    <button class="btn" style="background: #6f42c1;" onclick="downloadJSON()">Backup (JSON)</button>
    <label for="uploadJSON" class="btn" style="background: #fd7e14; display: inline-block;">Restore (Upload)</label>
    <input type="file" id="uploadJSON" style="display:none;" accept=".json" onchange="uploadJSON(event)">
    
    <button class="btn" style="background: #28a745;" onclick="window.print()">প্রিন্ট করুন</button>
    <button class="btn" style="background: #dc3545;" onclick="clearLocalStorage()">Reset All</button>
</div>

<div class="container">
    <div class="institute-header">
        <h3 id="instName" contenteditable="true" oninput="saveAllData()">আপনার প্রতিষ্ঠানের নাম</h3>
        <p id="instAddr" contenteditable="true" oninput="saveAllData()">প্রতিষ্ঠানের ঠিকানা</p>
    </div>

    <div class="header">
        <h4>উত্তরপত্র বিতরণ ও সংগ্রহ তালিকা</h4>
        <p><b>পরীক্ষার নাম:</b> <span id="examName" contenteditable="true" oninput="saveAllData()">...................</span>, <b>তারিখ:</b> <span id="examDate" contenteditable="true" oninput="saveAllData()">...................</span></p>
    </div>

    <table id="mainTable">
        <thead>
            <tr>
                <th width="18%">কক্ষ নং</th>
                <th width="28%">পরীক্ষকের নাম</th>
                <th width="12%">প্রদানকৃত</th>
                <th width="12%">ব্যবহৃত</th>
                <th width="12%">ফেরত</th>
                <th width="18%">স্বাক্ষর</th>
            </tr>
        </thead>
        <tbody id="table-body"></tbody>
        <tfoot>
            <tr class="total-row">
                <td colspan="2">সর্বমোট (Total)</td>
                <td id="total-given"></td>
                <td id="total-used"></td>
                <td id="total-returned"></td>
                <td></td>
            </tr>
        </tfoot>
    </table>

    <div class="footer">
        <div class="sig-box">হল সুপার</div>
        <div class="sig-box">কেন্দ্র সচিব / ভারপ্রাপ্ত কর্মকর্তা</div>
    </div>
</div>

<script>
    function checkPass() {
      const input = document.getElementById('pass-input').value;
      if (input === "12345678") {
        document.getElementById('login-screen').style.display = 'none';
      } else {
        document.getElementById('error-msg').style.display = 'block';
      }
    }

    function getTeacherOptions() {
        const list = document.getElementById('teacherList').value.split(',');
        let options = '<option value="">শিক্ষক নির্বাচন</option>';
        list.forEach(name => { if(name.trim()!="") options += `<option>${name.trim()}</option>`; });
        return options;
    }

    function addRow(savedData = null) {
        const tbody = document.getElementById('table-body');
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td class="room-col"><input type="text" class="room-input" oninput="saveAllData()" value="${savedData?savedData.room:''}"></td>
            <td><select onchange="saveAllData()">${getTeacherOptions()}</select></td>
            <td class="val-col"><input type="number" class="given" oninput="updateGrandTotal(); saveAllData()" value="${savedData?savedData.given:''}"></td>
            <td class="val-col"><input type="number" class="used" oninput="updateGrandTotal(); saveAllData()" value="${savedData?savedData.used:''}"></td>
            <td class="val-col"><input type="text" class="returned" readonly value="${savedData?savedData.ret:''}"></td>
            <td></td>
        `;
        if(savedData && savedData.teacher) tr.querySelector('select').value = savedData.teacher;
        tbody.appendChild(tr);
    }

    function updateGrandTotal() {
        let g=0, u=0, r=0;
        let hasG=false, hasU=false, hasR=false;
        document.querySelectorAll('#table-body tr').forEach(row => {
            if (row.querySelector('.val-col').style.display !== 'none') {
                const givenVal = row.querySelector('.given').value;
                const usedVal = row.querySelector('.used').value;
                const given = parseFloat(givenVal) || 0;
                const used = parseFloat(usedVal) || 0;
                const retField = row.querySelector('.returned');
                if(givenVal !== "" || usedVal !== "") {
                    retField.value = given - used;
                    g += given; u += used; r += (given-used);
                    if(givenVal !== "") hasG = true;
                    if(usedVal !== "") hasU = true;
                    hasR = true;
                } else { retField.value = ""; }
            }
        });
        document.getElementById('total-given').innerText = hasG ? g : "";
        document.getElementById('total-used').innerText = hasU ? u : "";
        document.getElementById('total-returned').innerText = hasR ? r : "";
    }

    function saveAllData() {
        const data = {
            instName: document.getElementById('instName').innerText,
            instAddr: document.getElementById('instAddr').innerText,
            examName: document.getElementById('examName').innerText,
            examDate: document.getElementById('examDate').innerText,
            teachers: document.getElementById('teacherList').value,
            rows: []
        };
        document.querySelectorAll('#table-body tr').forEach(row => {
            data.rows.push({
                room: row.querySelector('.room-input').value,
                teacher: row.querySelector('select').value,
                given: row.querySelector('.given').value,
                used: row.querySelector('.used').value,
                ret: row.querySelector('.returned').value
            });
        });
        localStorage.setItem('examData_v1', JSON.stringify(data));
    }

    function downloadJSON() {
        const savedData = localStorage.getItem('examData_v1');
        if (!savedData) { alert("কোনো ডাটা নেই!"); return; }
        const blob = new Blob([savedData], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Register_Backup_${new Date().toLocaleDateString()}.json`;
        a.click();
    }

    function uploadJSON(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                if(confirm("আগের ডাটা মুছে ফাইল থেকে রিস্টোর করবেন?")) {
                    localStorage.setItem('examData_v1', JSON.stringify(data));
                    location.reload();
                }
            } catch (err) { alert("সঠিক JSON ফাইল নয়!"); }
        };
        reader.readAsText(file);
    }

    function loadData() {
        const saved = localStorage.getItem('examData_v1');
        if (saved) {
            const data = JSON.parse(saved);
            document.getElementById('instName').innerText = data.instName;
            document.getElementById('instAddr').innerText = data.instAddr;
            document.getElementById('examName').innerText = data.examName;
            document.getElementById('examDate').innerText = data.examDate;
            document.getElementById('teacherList').value = data.teachers;
            if(data.rows && data.rows.length > 0) data.rows.forEach(row => addRow(row)); else addRow();
        } else { addRow(); }
        updateGrandTotal();
    }

    function clearLocalStorage() {
        if(confirm("সব ডাটা মুছে ফেলবেন?")) { localStorage.removeItem('examData_v1'); location.reload(); }
    }

    function mergeCells() {
        const rows = document.getElementById('table-body').rows;
        for(let r of rows) {
            r.querySelector('.room-col').style.display = '';
            r.querySelector('.room-col').rowSpan = 1;
            r.querySelectorAll('.val-col').forEach(td => { td.style.display = ''; td.rowSpan = 1; });
        }
        for (let i = 0; i < rows.length; i++) {
            let roomVal = rows[i].querySelector('.room-input').value.trim();
            if (!roomVal) continue;
            let span = 1;
            for (let j = i + 1; j < rows.length; j++) {
                if (rows[j].querySelector('.room-input').value.trim() === roomVal) {
                    span++;
                    rows[j].querySelector('.room-col').style.display = 'none';
                    rows[j].querySelectorAll('.val-col').forEach(td => td.style.display = 'none');
                } else { break; }
            }
            if (span > 1) {
                rows[i].querySelector('.room-col').rowSpan = span;
                rows[i].querySelectorAll('.val-col').forEach(td => td.rowSpan = span);
                i += (span - 1);
            }
        }
    }
    window.onload = loadData;
</script>
</body>
</html>